# 詳細診断モード - 商談成功率リアルタイム分析 機能仕様

## 1. 機能概要

- **目的**: 詳細診断モードで営業担当者（ユーザー）が送信する各メッセージに対し、会話内容を分析して商談成功率（0〜100%）をリアルタイムに更新する。
- **効果**: 質の高い質問が成功率を引き上げ、浅い質問は成功率を下げることで、ユーザーが会話の質を即座に把握できる。
- **対象モード**: 詳細診断モードのみ（簡易診断モードは対象外）。
- **更新タイミング**: ユーザーがチャットでメッセージを送るたび（= `chat_session` API 呼び出しごと）。
- **初期値**: 詳細診断モードでセッション開始時に 50%（設定可能）。

## 2. 画面/UI 仕様

- チャット画面（`step3`）に「商談成功率」パネルを追加。
    - 表示項目
        - 現在の成功率（例: `商談成功率: 54%`）
        - 前回からの変化量（例: `+4%` / `-3%`）
        - 変動理由（例: 「課題を具体的に掘り下げたため」）
- 成功率はリアルタイムに更新し、変動時は軽いアニメーションで強調。
- ログビューアーにも、成功率変動ログを出力して学習に活用。

## 3. データモデル

### 3.1 `Session` モデル拡張

- フィールド追加例
    ```python
    success_probability = models.IntegerField(default=50, help_text="現在の商談成功率 (0-100%)")
    last_analysis_reason = models.TextField(null=True, blank=True, help_text="直近の変動理由")
    ```
- 初期化: `start_session` 詳細診断モードで 50% にセット。

### 3.2 `ChatMessage` 拡張（オプション）

- 各メッセージに分析結果を紐付ける場合は以下のフィールドを検討。
    ```python
    success_delta = models.IntegerField(null=True, blank=True, help_text="この発言による成功率変動")
    analysis_summary = models.TextField(null=True, blank=True, help_text="分析サマリー")
    ```
- 必須ではないが、チャート表示やレポート機能拡張に備えて持っておくと便利。

## 4. API 仕様

### 4.1 `POST /api/session/chat/`

- **入力**: 既存仕様通り (`session_id`, `message`)。
- **処理フロー追加**:
    1. 既存どおりメッセージを保存。
    2. 詳細診断モードかつ `session.company` が存在する場合のみ分析を実行。
    3. OpenAI による簡易分析 API を呼び出し、以下の情報を取得。
        - `success_delta`: -10〜+10 などの整数
        - `reason`: 変動理由テキスト
        - 参考: `analysis_notes`（ログ用途）
    4. `Session.success_probability` に `success_delta` を適用。
        - 上限・下限（0〜100）でクリップ。
    5. 応答 JSON に以下を追加。
        ```json
        {
          "success_probability": 54,
          "success_delta": 4,
          "analysis_reason": "課題の背景を具体的に確認できたため"
        }
        ```
- **レスポンス**: 既存の `messages` 配列に加えて上記項目を返却。

### 4.2 OpenAI プロンプト（分析用）

- 軽量かつ応答速度重視のため `gpt-4o-mini` 継続利用予定。
- プロンプト内容（案）
    - 入力
        - 最新の会話（直近5往復程度）
        - 今回の営業発言
        - 企業情報サマリー
        - 現在の成功率
    - 出力
        ```json
        {
          "success_delta": 4,
          "reason": "顧客の現状を具体的に確認でき、先方の課題意識を高めたため",
          "notes": "質問が課題の深堀りに繋がった"
        }
        ```
- エッジケース
    - 質問が短すぎる／雑談の場合は `success_delta = 0`。
    - 不適切な質問や話題逸脱時は大きくマイナス。

## 5. フロントエンド仕様

1. 成功率パネルの追加
    - DOM 要素 ID: `successMeter`
    - レイアウト: チャット画面のヘッダ内（企業概要の下）
    - デザイン: 数字と矢印/アイコン、理由テキスト
2. API 応答の `success_probability` などを受け取り、即時反映
3. 変動履歴をロガーに出力
4. 初期値 50% を詳細診断モード開始時にセット

## 6. 分析ロジック詳細

### 6.1 成功率変動ルール（案）

- `success_delta` の範囲: -5 〜 +5
- 評価観点
    1. 顧客状況の把握度
    2. 課題深掘りの深さ
    3. 提案価値との関連性
    4. 顧客視点・共感の具合
- これら項目を 0〜2 点で評価し、合計点を `success_delta` に変換
- OpenAI 応答を妥当性チェック（値域・型）したうえで利用

### 6.2 キャッシュ / コスト対策

- すべての発言で OpenAI を呼ぶとトークン消費が増加するため、以下を検討。
    - 1メッセージごとに 1 回（最初の実装）
    - 後続で「一定間隔のみ分析」などのモードを足せるよう、設定化する

## 7. 実装手順（フェーズ分割）

1. **AIdocs 更新（完了）**
2. **モデル・マイグレーション作成** (`success_probability`, `last_analysis_reason` など)
3. **OpenAI サービス実装**（新規: `services/conversation_analysis.py` など）
4. **`chat_session` 更新**
    - 分析呼び出し
    - 成功率更新＆レスポンス拡張
5. **フロントエンド更新**
    - UI 表示
    - 成功率更新ロジック
6. **テスト & チューニング**
    - 初期値・変動幅調整
    - 長時間会話での遷移確認

## 8. 今後の拡張案

- 成功率の推移グラフ（ラインチャート）表示
- 成功率と SPIN スコアの連携
- 会話終了時レポートに推移とハイライトを掲載
- 変動理由をもとに AI コーチから改善アドバイスを提示

## 9. 注意事項

- 詳細診断モードに限定することで、企業情報を活用した評価に集中。
- 成功率はあくまで「AI による推定」であり、誤差がある旨を UI 上で明示する。
- API 応答が遅延した場合のフォールバック（例: `success_delta = 0`）を実装。

